<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Joy – A Life Well Lived</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* Smart Chat style: gradient dưới trái (xanh nhạt) → trên phải (lavender), minimal */
      :root {
        --bg-green: #e8f5e9;
        --bg-lavender: #f3e8ff;
        --purple-dark: #5b21b6;
        --purple-darker: #4c1d95;
        --text-dark: #1f2937;
        --text-muted: #6b7280;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(to top right, var(--bg-green) 0%, #e0f2e9 40%, #ede9fe 70%, var(--bg-lavender) 100%);
        background-attachment: fixed;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      /* Khung chat dùng luôn nền gradient của trang; mobile: full màn hình */
      .chat-container {
        width: 100%;
        max-width: 420px;
        height: 90vh;
        max-height: 780px;
        background: transparent;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      }

      @media (max-width: 480px) {
        body {
          padding: 0;
          align-items: stretch;
        }
        .chat-container {
          max-width: none;
          height: 100vh;
          max-height: none;
          border-radius: 0;
          box-shadow: none;
        }
        .chat-header {
          border-radius: 0;
        }
      }

      .chat-header {
        padding: 16px 20px;
        background: rgba(243, 232, 255, 0.9);
        color: var(--text-dark);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        border-radius: 24px 24px 0 0;
        text-align: center;
      }

      .chat-header-title {
        font-weight: 600;
        font-size: 18px;
        letter-spacing: -0.02em;
      }

      .chat-header-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: transparent;
      }

      .message-row {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        margin-bottom: 14px;
      }
      .message-row.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 36px;
        height: 36px;
        min-width: 36px;
        border-radius: 50%;
        background: var(--purple-dark);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }
      .message-row.user .message-avatar {
        display: none;
      }

      .message-bubble {
        max-width: 78%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.45;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .message-row.user .message-bubble {
        background: var(--purple-dark);
        color: #fff;
        border-bottom-right-radius: 6px;
        box-shadow: 0 2px 12px rgba(91, 33, 182, 0.25);
      }
      .message-row.joy .message-bubble {
        background: #fff;
        color: var(--text-dark);
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }

      .chat-input-bar {
        padding: 12px 16px 20px;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        gap: 10px;
        align-items: center;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
      }

      .chat-input-wrap {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chat-input {
        border-radius: 20px;
        border: none;
        padding: 12px 16px;
        font-size: 15px;
        outline: none;
        background: #fff;
        color: var(--text-dark);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        transition: box-shadow 0.2s;
      }

      .chat-input:focus {
        box-shadow: 0 2px 14px rgba(91, 33, 182, 0.15);
      }

      .chat-input::placeholder {
        color: var(--text-muted);
      }

      .chat-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chat-meta input {
        flex: 1;
        min-width: 100px;
        padding: 8px 12px;
        font-size: 13px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        outline: none;
      }

      .chat-meta input:focus {
        box-shadow: 0 2px 8px rgba(91, 33, 182, 0.12);
      }

      .user-info-display {
        font-size: 12px;
        color: var(--text-muted);
        padding: 4px 0;
      }

      .user-info-display strong {
        color: var(--purple-dark);
      }

      .send-button {
        border: none;
        background: var(--purple-dark);
        color: #fff;
        width: 48px;
        height: 48px;
        min-width: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(91, 33, 182, 0.35);
        transition: background 0.2s, transform 0.15s;
      }

      .send-button:hover:not(:disabled) {
        background: var(--purple-darker);
        transform: scale(1.05);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .send-button svg {
        width: 22px;
        height: 22px;
        margin-left: 2px;
      }

      .status {
        font-size: 11px;
        color: var(--text-muted);
        padding: 4px 16px 0;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-header-title">Joy · A Life Well Lived - Sống Chất</div>
        <div class="chat-header-subtitle">Trợ lý dự án A Life Well Lived - Sống Chất · Đa ngôn ngữ</div>
      </div>
      <div id="messages" class="chat-messages"></div>
      <div id="status" class="status"></div>
      <div class="chat-input-bar">
        <div class="chat-input-wrap">
          <div id="userInfoArea">
            <div class="chat-meta" id="userInfoInputs">
              <input id="userName" type="text" placeholder="Tên của bạn (tùy chọn)" title="Điền để Joy và admin biết bạn là ai khi xem lịch sử" />
              <input id="userContact" type="text" placeholder="SĐT hoặc Email (tùy chọn)" title="Điền để liên hệ lại khi cần" />
            </div>
            <div class="user-info-display" id="userInfoDisplay" style="display: none;"></div>
          </div>
          <input
            id="input"
            class="chat-input"
            type="text"
            placeholder="Nhập tin nhắn..."
          />
        </div>
        <button type="button" id="send" class="send-button" title="Gửi" aria-label="Gửi">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        </button>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");

      const history = [];
      let isSending = false;
      const STORAGE_KEY = "joy_session_id";
      const STORAGE_USER_NAME = "joy_user_name";
      const STORAGE_USER_CONTACT = "joy_user_contact";

      function getSessionId() {
        try {
          let sid = localStorage.getItem(STORAGE_KEY);
          if (sid) return sid;
          sid = typeof crypto !== "undefined" && crypto.randomUUID ? crypto.randomUUID() : "web-" + Date.now() + "-" + Math.random().toString(36).slice(2, 10);
          localStorage.setItem(STORAGE_KEY, sid);
          return sid;
        } catch (e) { return "web-" + Date.now(); }
      }

      function getSavedUserInfo() {
        try {
          return {
            name: (localStorage.getItem(STORAGE_USER_NAME) || "").trim(),
            contact: (localStorage.getItem(STORAGE_USER_CONTACT) || "").trim(),
          };
        } catch (e) { return { name: "", contact: "" }; }
      }

      function saveUserInfo(name, contact) {
        try {
          if (name) localStorage.setItem(STORAGE_USER_NAME, name);
          if (contact) localStorage.setItem(STORAGE_USER_CONTACT, contact);
          updateUserInfoDisplay();
        } catch (e) {}
      }

      function updateUserInfoDisplay() {
        const saved = getSavedUserInfo();
        const hasSaved = saved.name || saved.contact;
        const inputsEl = document.getElementById("userInfoInputs");
        const displayEl = document.getElementById("userInfoDisplay");
        if (hasSaved) {
          inputsEl.style.display = "none";
          displayEl.style.display = "block";
          const parts = [saved.name, saved.contact].filter(Boolean);
          displayEl.innerHTML = "Bạn: <strong>" + parts.join(" · ") + "</strong>";
        } else {
          inputsEl.style.display = "flex";
          displayEl.style.display = "none";
        }
      }

      async function loadHistory() {
        const sessionId = getSessionId();
        try {
          const res = await fetch("/api/history?session_id=" + encodeURIComponent(sessionId));
          const data = await res.json();
          const list = data.messages || [];
          if (list.length === 0) return false;
          for (const m of list) {
            addMessage(m.role === "user" ? "user" : "joy", m.text || "");
            history.push({ role: m.role === "user" ? "user" : "model", text: m.text || "" });
          }
          return true;
        } catch (e) {
          console.warn("Load history failed:", e);
          return false;
        }
      }

      function clearInput() {
        inputEl.value = "";
        setTimeout(function () {
          inputEl.value = "";
          inputEl.focus();
        }, 80);
      }

      function addMessage(role, text) {
        const row = document.createElement("div");
        row.className = "message-row " + (role === "user" ? "user" : "joy");

        if (role === "joy") {
          const avatar = document.createElement("div");
          avatar.className = "message-avatar";
          avatar.setAttribute("aria-hidden", "true");
          avatar.innerHTML = "&#10024;"; /* ✨ */
          row.appendChild(avatar);
        }

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.appendChild(document.createTextNode(text));
        row.appendChild(bubble);

        messagesEl.appendChild(row);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        if (isSending) return;
        isSending = true;
        sendBtn.disabled = true;
        statusEl.textContent = "Joy is thinking...";
        addMessage("user", text);
        history.push({ role: "user", text });
        clearInput();

        try {
          const sessionId = getSessionId();
          const saved = getSavedUserInfo();
          let userName = saved.name;
          let userContact = saved.contact;
          const nameInput = document.getElementById("userName");
          const contactInput = document.getElementById("userContact");
          if (nameInput && (nameInput.value || "").trim()) userName = (nameInput.value || "").trim();
          if (contactInput && (contactInput.value || "").trim()) userContact = (contactInput.value || "").trim();
          if (userName || userContact) saveUserInfo(userName, userContact);
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              history,
              session_id: sessionId,
              user_name: userName || undefined,
              user_contact: userContact || undefined,
            }),
          });

          const data = await res.json();
          if (data.error) {
            addMessage("joy", "Xin lỗi, Joy gặp lỗi: " + data.error);
          } else {
            if (data.session_id) try { localStorage.setItem(STORAGE_KEY, data.session_id); } catch (_) {}
            let reply = data.reply || "(no reply)";
            reply = reply.replace(/\*\*/g, "");
            addMessage("joy", reply);
            history.push({ role: "model", text: reply });
          }
        } catch (err) {
          console.error(err);
          addMessage(
            "joy",
            "Xin lỗi, Joy không thể kết nối tới máy chủ. Hãy thử lại sau."
          );
        } finally {
          isSending = false;
          sendBtn.disabled = false;
          statusEl.textContent = "";
          clearInput();
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      (async function init() {
        updateUserInfoDisplay();
        const hasHistory = await loadHistory();
        if (!hasHistory) {
          addMessage(
            "joy",
            "Xin chào bạn, tôi là Joy – trợ lý ảo của dự án A Life Well Lived - Sống Chất. Tôi có thể hỗ trợ bạn tìm hiểu thông tin về hệ sinh thái sức khỏe và kinh doanh của chúng tôi. Bạn cần tôi hỗ trợ điều gì hôm nay?"
          );
        }
      })();
    </script>
  </body>
  </html>

