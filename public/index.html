<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Joy – A Life Well Lived (Demo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f5f5f7;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      .chat-container {
        width: 100%;
        max-width: 420px;
        height: 80vh;
        max-height: 680px;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        padding: 14px 18px;
        background: linear-gradient(135deg, #2c5cff, #7b5cff);
        color: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .chat-header-title {
        font-weight: 600;
        font-size: 16px;
      }

      .chat-header-subtitle {
        font-size: 12px;
        opacity: 0.9;
      }

      .chat-messages {
        flex: 1;
        padding: 12px 12px 4px;
        overflow-y: auto;
        background: #f4f4fb;
      }

      .message {
        max-width: 80%;
        margin-bottom: 10px;
        padding: 8px 11px;
        border-radius: 14px;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
      }

      .message.user {
        margin-left: auto;
        background: #2c5cff;
        color: #ffffff;
        border-bottom-right-radius: 4px;
      }

      .message.joy {
        margin-right: auto;
        background: #ffffff;
        color: #1f2933;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .chat-input-bar {
        padding: 8px;
        border-top: 1px solid #e5e7eb;
        background: #ffffff;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .chat-input {
        flex: 1;
        border-radius: 16px;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        font-size: 14px;
        outline: none;
      }

      .chat-input:focus {
        border-color: #2c5cff;
        box-shadow: 0 0 0 1px rgba(44, 92, 255, 0.25);
      }

      .send-button {
        border: none;
        background: #2c5cff;
        color: white;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 14px;
        cursor: pointer;
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .status {
        font-size: 11px;
        color: #6b7280;
        padding: 0 12px 6px;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-header-title">Joy · A Life Well Lived - Sống Chất</div>
        <div class="chat-header-subtitle">
          Trợ lý dự án A Life Well Lived - Sống Chất · Đa ngôn ngữ
        </div>
      </div>
      <div id="messages" class="chat-messages"></div>
      <div id="status" class="status"></div>
      <div class="chat-input-bar">
        <input
          id="input"
          class="chat-input"
          type="text"
          placeholder="Type a message for Joy..."
        />
        <button type="button" id="send" class="send-button">Send</button>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");

      const history = [];
      let isSending = false;

      function clearInput() {
        inputEl.value = "";
        setTimeout(function () {
          inputEl.value = "";
          inputEl.focus();
        }, 80);
      }

      function addMessage(role, text) {
        const div = document.createElement("div");
        div.className = "message " + (role === "user" ? "user" : "joy");
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        if (isSending) return;
        isSending = true;
        sendBtn.disabled = true;
        statusEl.textContent = "Joy is thinking...";
        addMessage("user", text);
        history.push({ role: "user", text });
        clearInput();

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, history }),
          });

          const data = await res.json();
          if (data.error) {
            addMessage("joy", "Xin lỗi, Joy gặp lỗi: " + data.error);
          } else {
            let reply = data.reply || "(no reply)";
            reply = reply.replace(/\*\*/g, "");
            addMessage("joy", reply);
            history.push({ role: "model", text: reply });
          }
        } catch (err) {
          console.error(err);
          addMessage(
            "joy",
            "Xin lỗi, Joy không thể kết nối tới máy chủ. Hãy thử lại sau."
          );
        } finally {
          isSending = false;
          sendBtn.disabled = false;
          statusEl.textContent = "";
          clearInput();
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      addMessage(
        "joy",
        "Xin chào bạn, tôi là Joy – trợ lý ảo của dự án A Life Well Lived - Sống Chất. Tôi có thể hỗ trợ bạn tìm hiểu thông tin về hệ sinh thái sức khỏe và kinh doanh của chúng tôi. Bạn cần tôi hỗ trợ điều gì hôm nay?"
      );
    </script>
  </body>
  </html>

